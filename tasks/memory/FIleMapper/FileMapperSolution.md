
# External Merge Sort Utility
## Назначение
Утилита для работы с бинарными файлами, содержащими 64-битные целые числа (int64_t/long long). Реализует:
- Генерацию тестовых файлов
- Проверку сортировки
- Внешнюю сортировку (external sort) больших файлов

## Технические характеристикиё  
- **Формат данных**: бинарный, little-endian
- **Размер элемента**: 8 байт (int64_t)
- **Макс. размер файла**: ограничено только файловой системой
- **Потребление памяти**: контролируемое (задается параметром)

## Режимы работы
### 1. Генерация файла (`--gen`)
```bash
./program --gen <filename> <count> [sorted]
```
Параметры:
- `filename` - путь к выходному файлу
- `count` - количество чисел для генерации
- `sorted` (опц.) - генерировать предварительно отсортированные данные

### 2. Проверка сортировки (`--check`)
```bash
./program --check <filename>
```
Проверяет, отсортирован ли файл в порядке возрастания.

### 3. Сортировка файла
```bash
./program <filename> [limitMB]
```
Параметры:
- `filename` - файл для сортировки
- `limitMB` (опц.) - лимит памяти в мегабайтах

## Алгоритм сортировки
### Фаза 1: Разбиение на отсортированные блоки
1. Файл делится на чанки размером `limitMB`
2. Каждый чанк:
   - Загружается в память через mmap
   - Сортируется в памяти (std::sort)
   - Сохраняется во временный файл

### Фаза 2: K-way слияние
1. Создается min-heap для слияния K блоков
2. Алгоритм:
   - В куче хранятся текущие элементы из каждого блока
   - Извлекается минимальный элемент
   - Записывается в выходной буфер
   - При опустошении буфера - запись на диск
3. Процесс повторяется рекурсивно пока не останется 1 блок

## Оптимизации
- Использование mmap для эффективного доступа к файлам
- Динамический выбор K (количество сливаемых блоков)
- Двойная буферизация (чтение/запись)
- Проверка на предварительную сортировку

## Примеры использования
```bash
# Генерация случайного файла (10M чисел)
./program --gen data.bin 10000000

# Проверка сортировки
./program --check data.bin

# Сортировка с лимитом 512MB
./program data.bin 512

# Генерация отсортированного файла
./program --gen sorted.bin 500000 sorted
```

## Требования и ограничения
### Системные требования
- POSIX-совместимая ОС (Linux, macOS)
- Достаточное дисковое пространство (2x размера файла)
- Поддержка mmap

### Ограничения
- Только 64-битные целые числа
- Размер файла должен быть кратен 8 байтам
- Максимальное K = 1024 (количество сливаемых блоков)

## Примечания по производительности
1. Для файлов <100MB рекомендуется использовать in-memory сортировку
2. При отсутствии limitMB используется 10% от размера файла
3. Временные файлы создаются в той же директории
4. Проверка сортировки использует статистическую выборку для больших файлов

## Внутренняя структура
### Ключевые функции
- `generateFile()` - генерация тестовых данных
- `checkFile()` - проверка сортировки
- `externalSort()` - основная функция сортировки
- `sortChunkAndWrite()` - сортировка отдельного чанка
- `multiWayMerge()` - алгоритм k-слияния

### Структуры данных
- `MappedRegion` - работа с mmap-областями
- `RunInfo` - метаинформация о блоках
- `MergeRunState` - состояние слияния
- `HeapItem` - элемент для min-heap

## Обработка ошибок
Программа проверяет:
- Корректность открытия файлов
- Доступность памяти
- Целостность данных
- Соответствие размера файла

При ошибках:
- Выводится сообщение об ошибке
- Освобождаются ресурсы
- Программа завершается с кодом 1

## Советы по использованию
1. Для больших файлов (>1GB) задавайте явный limitMB
2. Проверяйте свободное место на диске перед сортировкой
3. Для тестирования используйте небольшие файлы (~1000 элементов)
4. Отсортированные файлы можно использовать как эталонные
```

